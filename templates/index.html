<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spot Welding Classifier</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #1f2226;
      color: #e8e8e8;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding-top: 20px;
      font-family: "Segoe UI", Tahoma, Arial, sans-serif;
    }
    .card {
      width: 680px;
      border-radius: 10px;
      background: #2a2d31;
      box-shadow: 0 6px 18px rgba(0,0,0,0.6);
      padding: 18px;
    }
    #videoWrapper {
      position: relative;
      width: 100%;
      background: #111;
      border-radius: 8px;
      overflow: hidden;
    }
    video {
      width: 100%;
      height: auto;
      display: block;
    }
    #overlayCanvas {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none; /* دایره کلیک‌پذیر نباشد */
    }
    #resultIcon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 44px;
      display: none;
      text-shadow: 0 2px 6px rgba(0,0,0,0.8);
    }
    #resultProb {
      position: absolute;
      top: calc(50% + 48px);
      left: 50%;
      transform: translateX(-50%);
      font-size: 16px;
      color: white;
      display: none;
      text-shadow: 0 2px 5px rgba(0,0,0,0.8);
    }
    .preview {
      width: 110px;
      height: 110px;
      object-fit: contain; /* حفظ نسبت تصویر */
      border-radius: 6px;
      border: 1px solid #444;
      background: #222;
    }
    .inputs .form-control {
      background: #151719;
      border: 1px solid #333;
      color: #e8e8e8;
    }
    .small-muted {
      color: #9aa0a6;
      font-size: 13px;
    }
    pre#normalized {
      background: #0e0f10;
      color: #bfe;
      padding: 8px;
      border-radius: 6px;
      max-height: 160px;
      overflow: auto;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h4 class="text-center mb-2">Spot Welding Quality Classifier</h4>

    <div id="videoWrapper" class="mb-3">
      <video id="video" autoplay playsinline></video>
      <canvas id="overlayCanvas"></canvas>
      <div id="resultIcon"></div>
      <div id="resultProb"></div>
    </div>

    <div class="d-flex justify-content-between mb-2">
      <div>
        <button id="captureB" class="btn btn-sm btn-primary">Capture Image B</button>
        <button id="captureF" class="btn btn-sm btn-secondary">Capture Image F</button>
      </div>
      <div class="small-muted">Make sure camera permission is granted. Use rear camera for best result.</div>
    </div>

    <div class="d-flex gap-3 mb-3">
      <div class="d-flex flex-column align-items-center">
        <div>Raw preview B</div>
        <img id="previewB" class="preview" src="" alt="raw B">
      </div>
      <div class="d-flex flex-column align-items-center">
        <div>Raw preview F</div>
        <img id="previewF" class="preview" src="" alt="raw F">
      </div>

      <div style="flex:1;">
        <div class="small-muted mb-1">Processed (what is sent to model)</div>
        <div id="processedPreviews" style="display:flex; gap:8px;">
          <!-- processed previews inserted here -->
        </div>
      </div>
    </div>

    <div class="inputs row gx-2 gy-2 mb-2">
      <div class="col-6"><input id="n0" class="form-control" placeholder="Pressure (PSI)"></div>
      <div class="col-6"><input id="n1" class="form-control" placeholder="Welding Time (ms)"></div>
      <div class="col-6"><input id="n2" class="form-control" placeholder="Angle (Deg)"></div>
      <div class="col-6"><input id="n3" class="form-control" placeholder="Thickness A (mm)"></div>
      <div class="col-6"><input id="n4" class="form-control" placeholder="Thickness B (mm)"></div>
      <div class="col-6"><input id="n5" class="form-control" placeholder="Material"></div>
      <div class="col-6"><input id="n6" class="form-control" placeholder="Force (N)"></div>
      <div class="col-6"><input id="n7" class="form-control" placeholder="Current (A)"></div>
    </div>

    <button id="predictBtn" class="btn btn-success w-100 mb-2">Predict</button>

    <div id="status" class="text-center small-muted mb-2">Status: idle</div>

    <div>
      <div class="small-muted">Normalized Inputs Sent to Model:</div>
      <pre id="normalized">-</pre>
    </div>

  </div>

  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    const video = document.getElementById('video');
    const overlayCanvas = document.getElementById('overlayCanvas');
    const ctxOverlay = overlayCanvas.getContext('2d');
    const canvas = document.getElementById('canvas');
    const previewB = document.getElementById('previewB');
    const previewF = document.getElementById('previewF');
    const processedPreviews = document.getElementById('processedPreviews');
    const resultIcon = document.getElementById('resultIcon');
    const resultProb = document.getElementById('resultProb');
    const status = document.getElementById('status');
    const normalizedBox = document.getElementById('normalized');

    let imgB = null, imgF = null;

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { exact: "environment" } }, audio: false
        });
        video.srcObject = stream;
      } catch (err) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
          video.srcObject = stream;
        } catch (e) {
          alert("Camera not available: " + e.message);
        }
      }
    }
    startCamera();

    // رسم دایره روی overlayCanvas
    function drawOverlay() {
      overlayCanvas.width = video.videoWidth;
      overlayCanvas.height = video.videoHeight;
      ctxOverlay.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
      const cx = overlayCanvas.width / 2;
      const cy = overlayCanvas.height / 2;
      const r = 110; // همون ابعاد دایره قبلی
      ctxOverlay.strokeStyle = "limegreen";
      ctxOverlay.lineWidth = 3;
      ctxOverlay.beginPath();
      ctxOverlay.arc(cx, cy, r, 0, 2 * Math.PI);
      ctxOverlay.stroke();
      requestAnimationFrame(drawOverlay);
    }
    requestAnimationFrame(drawOverlay);

    function captureToDataURL() {
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 480;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL('image/png');
    }

    document.getElementById('captureB').onclick = () => {
      imgB = captureToDataURL();
      previewB.src = imgB;
    };
    document.getElementById('captureF').onclick = () => {
      imgF = captureToDataURL();
      previewF.src = imgF;
    };

    async function predict() {
      if (!imgB || !imgF) {
        alert("Please capture both B and F images.");
        return;
      }
      const nums = [];
      for (let i = 0; i < 8; i++) {
        const val = document.getElementById('n' + i).value;
        nums.push(val === "" ? "" : val);
      }

      status.innerText = "Status: sending to server...";
      resultIcon.style.display = "none";
      resultProb.style.display = "none";
      processedPreviews.innerHTML = "";

      const payload = { imageB: imgB, imageF: imgF, numbers: nums };

      try {
        const resp = await fetch('/predict', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();

        if (data.error) {
          status.innerText = "Status: error - " + data.error;
          alert("Server error: " + data.error);
          return;
        }

        processedPreviews.innerHTML = "";
        if (data.previewB) {
          const i = document.createElement('img');
          i.src = data.previewB;
          i.className = 'preview';
          processedPreviews.appendChild(i);
        }
        if (data.previewF) {
          const j = document.createElement('img');
          j.src = data.previewF;
          j.className = 'preview';
          processedPreviews.appendChild(j);
        }

        if (data.normalized) {
          normalizedBox.innerText = JSON.stringify(data.normalized, null, 2);
        }

        const res = data.result;
        status.innerText = `Status: predicted ${res.label} (${(res.prob*100).toFixed(1)}%)`;

        resultIcon.style.display = "block";
        resultProb.style.display = "block";
        resultProb.innerText = (res.prob*100).toFixed(1) + "%";
        if (res.label === "Good") {
          resultIcon.innerText = "✔";
          resultIcon.style.color = "lime";
        } else if (res.label === "Bad") {
          resultIcon.innerText = "✖";
          resultIcon.style.color = "red";
        } else {
          resultIcon.innerText = "⚠";
          resultIcon.style.color = "orange";
        }

        console.log("server debug:", data.debug);
      } catch (err) {
        status.innerText = "Status: request failed";
        alert("Request failed: " + err);
        console.error(err);
      }
    }

    document.getElementById('predictBtn').addEventListener('click', predict);
  </script>
</body>
</html>
