<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Spot Welding Classifier</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f5f7fa;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    .card {
      width: 650px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    #videoWrapper {
      position: relative;
      display: inline-block;
    }
    #overlayCircle {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 3px solid green;
      border-radius: 50%;
      width: 250px;
      height: 250px;
      pointer-events: none;
    }
    #previewWrapper {
      margin-top: 15px;
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    .preview {
      border: 1px solid #ccc;
      border-radius: 8px;
      width: 120px;
      height: 120px;
      object-fit: contain;
      background: #eee;
    }
    #resultIcon {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 48px;
      display: none;
    }
    #loader {
      display: none;
    }
  </style>
</head>
<body>
  <div class="card p-4">
    <h3 class="text-center mb-3">Spot Welding Quality Classifier</h3>

    <!-- Camera Section -->
    <div id="videoWrapper">
      <video id="video" width="100%" autoplay></video>
      <div id="overlayCircle"></div>
      <div id="resultIcon"></div>
    </div>
    <canvas id="canvas" style="display:none;"></canvas>

    <!-- Controls -->
    <div class="d-flex justify-content-around my-3">
      <button id="captureB" class="btn btn-primary">Capture Image B</button>
      <button id="captureF" class="btn btn-secondary">Capture Image F</button>
    </div>

    <!-- Preview processed images -->
    <div id="previewWrapper">
      <img id="previewB" class="preview" alt="Preview B">
      <img id="previewF" class="preview" alt="Preview F">
    </div>

    <!-- Numeric Inputs -->
    <div class="row g-2 mt-3">
      <div class="col-6"><input class="form-control" placeholder="Pressure (PSI)"></div>
      <div class="col-6"><input class="form-control" placeholder="Welding Time (ms)"></div>
      <div class="col-6"><input class="form-control" placeholder="Angle (Deg)"></div>
      <div class="col-6"><input class="form-control" placeholder="Thickness A (mm)"></div>
      <div class="col-6"><input class="form-control" placeholder="Thickness B (mm)"></div>
      <div class="col-6"><input class="form-control" placeholder="Material"></div>
      <div class="col-6"><input class="form-control" placeholder="Force (N)"></div>
      <div class="col-6"><input class="form-control" placeholder="Current (A)"></div>
    </div>

    <button id="predictBtn" class="btn btn-success w-100 mt-3">Predict</button>

    <!-- Loader -->
    <div id="loader" class="text-center mt-3">
      <div class="spinner-border text-primary" role="status"></div>
      <p>Processing...</p>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const loader = document.getElementById('loader');
    const resultIcon = document.getElementById('resultIcon');
    const previewB = document.getElementById('previewB');
    const previewF = document.getElementById('previewF');
    let imgB = null, imgF = null;

    // Ask for rear camera
    navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } }, audio: false })
      .then(stream => video.srcObject = stream)
      .catch(err => {
        console.error("Camera error:", err);
        alert("Camera not available. Please allow camera access.");
      });

    // Capture helper
    function captureRawImage() {
      const ctx = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL("image/png");
    }

    // Function to send raw image to backend for preprocessing
    async function preprocessAndPreview(rawImg, which) {
      const res = await fetch("/preview", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ image: rawImg })
      });
      const data = await res.json();
      if (which === "B") {
        imgB = data.processed;
        previewB.src = data.processed;
      } else {
        imgF = data.processed;
        previewF.src = data.processed;
      }
    }

    document.getElementById("captureB").onclick = () => {
      const raw = captureRawImage();
      preprocessAndPreview(raw, "B");
    };
    document.getElementById("captureF").onclick = () => {
      const raw = captureRawImage();
      preprocessAndPreview(raw, "F");
    };

    document.getElementById("predictBtn").onclick = async () => {
      if (!imgB || !imgF) {
        alert("Please capture both Image B and Image F first.");
        return;
      }
      const nums = Array.from(document.querySelectorAll(".form-control")).map(i => i.value);
      const payload = { imageB: imgB, imageF: imgF, numbers: nums };

      loader.style.display = "block";
      resultIcon.style.display = "none";

      const res = await fetch("/predict", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const data = await res.json();

      loader.style.display = "none";

      if (data.label === "Good") {
        resultIcon.innerHTML = "✅";
        resultIcon.style.color = "green";
      } else if (data.label === "Bad") {
        resultIcon.innerHTML = "❌";
        resultIcon.style.color = "red";
      } else {
        resultIcon.innerHTML = "⚠️";
        resultIcon.style.color = "orange";
      }
      resultIcon.style.display = "block";
    };
  </script>
</body>
</html>
